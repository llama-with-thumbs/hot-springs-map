<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Hot Springs Map</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>♨️</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div class="map-section">
        <div id="map">
          <div id="legend" class="map-legend">
            <h4>Legend</h4>
            <div><b>SC</b>: State Code</div>
            <div><b>TF</b>: Max surface temp (°F, B=boiling, H=hot, W=warm)</div>
            <div><b>TC</b>: Max surface temp (°C, B=boiling, H=hot, W=warm)</div>
            <div><b>P.P. 492</b>: USGS Prof. Paper 492 (Waring, 1965)</div>
            <div><b>Circ. 790</b>: USGS Circular 790 (Muffler, 1979)</div>
            <div><b>NOAA</b>: 1:250,000 overlays in NOAA KGRD 12 (Berry, Grim, Ikelman, 1980)</div>
            <div><b>AMS</b>: 1:250,000 AMS Maps</div>
            <div><b>USGS quadrangle</b>: 15 or 7.5-min quadrangle location</div>
          </div>
        </div>
      </div>
      <aside class="search-section">
        <label id="search-label" for="search">Search springs by name</label>
        <div class="search-row">
          <input id="search" type="text" placeholder="Type a spring name..." autocomplete="off" />
          <button id="search-clear" title="Clear search" tabindex="-1">&times;</button>
          <button id="search-btn" type="button">Search</button>
        </div>
        <div id="search-results" style="margin-top: 18px; width: 100%"></div>
      </aside>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([39, -100], 4);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let markerList = [];

      function bounceMarker(marker) {
        // Only bounce if icon is present (marker is on map)
        if (marker._icon) {
          marker._icon.classList.add("highlight-marker");
          setTimeout(() => {
            if (marker._icon) marker._icon.classList.remove("highlight-marker");
          }, 600);
        }
      }

      function doSearch() {
        const query = document.getElementById("search").value.trim().toLowerCase();
        if (!query) {
          resetMapView();
        }
        const resultsDiv = document.getElementById("search-results");
        let resultsHtml = "";
        let matches = [];

        markerList.forEach(({ marker, name }, idx) => {
          if (name && name.toLowerCase().includes(query) && query.length > 0) {
            if (!map.hasLayer(marker)) marker.addTo(map); // Show
            bounceMarker(marker);
            if (marker.setZIndexOffset) marker.setZIndexOffset(1000);
            matches.push({ marker, idx });
          } else if (query.length > 0) {
            if (map.hasLayer(marker)) marker.remove(); // Hide
            if (marker.setZIndexOffset) marker.setZIndexOffset(0);
          } else {
            if (!map.hasLayer(marker)) marker.addTo(map); // Show all on reset
            if (marker.setZIndexOffset) marker.setZIndexOffset(0);
          }
        });

        // Show up to 5 results
        if (query.length === 0 || matches.length === 0) {
          resultsHtml = matches.length === 0 && query.length > 0 ? "<div>No matches found.</div>" : "";
        } else {
          resultsHtml = "<ul style='list-style:none;padding:0;margin:0;'>";
          matches.slice(0, 5).forEach(({ marker }, i) => {
            const props = marker.feature.properties;
            resultsHtml += `
        <li style="margin-bottom:14px;">
          <a href="#" style="font-weight:600;font-size:1.05em;color:#255bbd;text-decoration:none;" onclick="focusSpring(${
            marker._leaflet_id
          });return false;">
            ${props["Spring Name"] || "Hot Spring"}
          </a>
          <div style="color:#444;font-size:0.95em;">
            ${props.SC ? props.SC + ", " : ""}${props["USGS Quadrangle"] ? props["USGS Quadrangle"] : ""}
            ${props.TF ? `<span style="color:#666;">, ${props.TF}°F</span>` : ""}
          </div>
        </li>
      `;
          });
          resultsHtml += "</ul>";
          if (matches.length > 5) {
            resultsHtml += `<div style="color:#888;font-size:0.97em;">${matches.length - 5} more found...</div>`;
          }
        }
        resultsDiv.innerHTML = resultsHtml;

        // Scroll to results if on mobile
        if (window.innerWidth < 900) {
          resultsDiv.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // Helper: Clicking result opens marker popup and centers map
        window.focusSpring = function (leafletId) {
          const found = markerList.find(({ marker }) => marker._leaflet_id === leafletId);
          if (found) {
            map.setView(found.marker.getLatLng(), 11, { animate: true });
            found.marker.openPopup();
            bounceMarker(found.marker);
          }
        };
      }

      function resetMapView() {
        map.setView([39, -100], 4);
        markerList.forEach(({ marker }) => {
          if (!map.hasLayer(marker)) marker.addTo(map); // Show all
          if (marker.setStyle) marker.setStyle({ opacity: 1, fillOpacity: 0.95 });
          if (marker.setOpacity) marker.setOpacity(1);
          if (marker.setZIndexOffset) marker.setZIndexOffset(0);
        });
      }

      // Search button click
      document.getElementById("search-btn").addEventListener("click", doSearch);

      // Enter key in search input
      document.getElementById("search").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          doSearch();
        }
      });

      // Show/hide clear button and clear on click
      const searchInput = document.getElementById("search");
      const clearBtn = document.getElementById("search-clear");

      searchInput.addEventListener("input", function () {
        clearBtn.style.display = searchInput.value.length > 0 ? "block" : "none";
      });

      clearBtn.addEventListener("click", function () {
        searchInput.value = "";
        clearBtn.style.display = "none";
        doSearch(); // This will reset markers, but let’s add resetMapView for zoom too
        resetMapView();
        searchInput.focus();
      });

      fetch("hot_springs.geojson")
        .then((response) => response.json())
        .then((data) => {
          markerList = [];
          L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
              const props = feature.properties || {};

              const marker = L.circleMarker(latlng, {
                radius: 5,
                color: "#56130e", // Border color
                fillColor: "#e03426", // Fill color
                fillOpacity: 0.95,
                weight: 1,
              });
              let popupContent = `<strong>${props["Spring Name"] || "Hot Spring"}</strong>`;
              Object.entries(props).forEach(([key, value]) => {
                if (key !== "Spring Name" && value && value !== "null") popupContent += `<br><b>${key}:</b> ${value}`;
              });
              marker.bindPopup(popupContent);
              marker.addTo(map);
              markerList.push({ marker, name: props["Spring Name"] || "" });
              return marker;
            },
          });
        });
    </script>
  </body>
</html>
