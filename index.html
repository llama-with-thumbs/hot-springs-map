<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Hot Springs Map</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>♨️</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #f6f7fa;
        font-family: system-ui, sans-serif;
      }
      .container {
        display: flex;
        height: 100vh;
        width: 100vw;
      }
      .map-section {
        flex: 3;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9eef6;
      }
      #map {
        position: relative;
        height: 80vh;
        width: 95%;
        max-width: 1200px;
        border-radius: 20px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
        margin: auto;
      }
      .search-section {
        flex: 1;
        background: #fff;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 48px 24px 24px 18px;
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.04);
        min-width: 240px;
      }
      #search-label {
        font-size: 1.2rem;
        margin-bottom: 14px;
        color: #222;
      }
      .search-row {
        display: flex;
        flex-direction: row;
        width: 100%;
        gap: 10px;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
      }
      #search {
        flex: 1;
        min-width: 0;
        padding: 10px 36px 10px 14px; /* Make room for clear button */
        font-size: 1rem;
        border-radius: 7px;
        border: 1px solid #bbb;
        background: #fafbfe;
        box-sizing: border-box;
      }
      #search-clear {
        display: none;
        position: absolute;
        right: 98px; /* 98px leaves room for search button */
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1em;
        color: #aaa;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0 6px;
        z-index: 10;
        line-height: 1;
        transition: color 0.2s;
      }
      #search-clear:hover {
        color: #e44;
      }
      #search-btn {
        padding: 10px 20px;
        font-size: 1rem;
        border-radius: 7px;
        border: none;
        background: #4876ec;
        color: #fff;
        cursor: pointer;
        transition: background 0.2s;
        font-weight: 500;
      }
      #search-btn:hover {
        background: #365dc6;
      }
      .highlight-marker {
        animation: bounce 0.6s;
        filter: drop-shadow(0 0 7px #fc0);
      }
      @keyframes bounce {
        0% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-18px);
        }
        50% {
          transform: translateY(0);
        }
        70% {
          transform: translateY(-8px);
        }
        100% {
          transform: translateY(0);
        }
      }
      .map-legend {
        position: absolute;
        bottom: 18px;
        left: 18px;
        background: rgba(255, 255, 255, 0.96);
        border: 1.5px solid #b5bdd6;
        border-radius: 12px;
        padding: 10px 12px 8px 12px;
        box-shadow: 0 4px 14px rgba(80, 90, 150, 0.09);
        font-size: 0.82em;
        min-width: 170px;
        max-width: 235px;
        z-index: 1200;
        color: #1e2335;
        line-height: 1.32;
        pointer-events: auto; /* allow interaction if needed */
      }
      .map-legend h4 {
        margin: 0 0 5px 0;
        font-size: 1em;
        font-weight: 700;
        letter-spacing: 1px;
        color: #365dc6;
      }
      @media (max-width: 900px) {
        .container {
          flex-direction: column;
        }
        .map-section,
        .search-section {
          width: 100%;
          max-width: 100vw;
        }
        #map {
          width: 100vw;
          height: 48vh;
          max-width: 100vw;
        }
        .search-section {
          min-width: 0;
          padding: 24px 12px;
        }
        .search-row {
          flex-direction: column;
          gap: 8px;
        }
        #search-btn {
          width: 100%;
        }
        #search-clear {
          right: 18px;
        }
        .map-legend {
          position: static;
          max-width: 99vw;
          margin: 16px auto 0 auto;
          left: 0;
          right: 0;
          font-size: 1em;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="map-section">
        <div id="map">
          <div id="legend" class="map-legend">
            <h4>Legend</h4>
            <div><b>SC</b>: State Code</div>
            <div><b>TF</b>: Max surface temp (°F, B=boiling, H=hot, W=warm)</div>
            <div><b>TC</b>: Max surface temp (°C, B=boiling, H=hot, W=warm)</div>
            <div><b>P.P. 492</b>: USGS Prof. Paper 492 (Waring, 1965)</div>
            <div><b>Circ. 790</b>: USGS Circular 790 (Muffler, 1979)</div>
            <div><b>NOAA</b>: 1:250,000 overlays in NOAA KGRD 12 (Berry, Grim, Ikelman, 1980)</div>
            <div><b>AMS</b>: 1:250,000 AMS Maps</div>
            <div><b>USGS quadrangle</b>: 15 or 7.5-min quadrangle location</div>
          </div>
        </div>
      </div>
      <aside class="search-section">
        <label id="search-label" for="search">Search springs by name</label>
        <div class="search-row">
          <input id="search" type="text" placeholder="Type a spring name..." autocomplete="off" />
          <button id="search-clear" title="Clear search" tabindex="-1">&times;</button>
          <button id="search-btn" type="button">Search</button>
        </div>
        <div id="search-results" style="margin-top: 18px; width: 100%"></div>
      </aside>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([39, -100], 4);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let markerList = [];

      function bounceMarker(marker) {
        // Only bounce if icon is present (marker is on map)
        if (marker._icon) {
          marker._icon.classList.add("highlight-marker");
          setTimeout(() => {
            if (marker._icon) marker._icon.classList.remove("highlight-marker");
          }, 600);
        }
      }

      function doSearch() {
        const query = document.getElementById("search").value.trim().toLowerCase();
        if (!query) {
          resetMapView();
        }
        const resultsDiv = document.getElementById("search-results");
        let resultsHtml = "";
        let matches = [];

        markerList.forEach(({ marker, name }, idx) => {
          if (name && name.toLowerCase().includes(query) && query.length > 0) {
            if (!map.hasLayer(marker)) marker.addTo(map); // Show
            bounceMarker(marker);
            if (marker.setZIndexOffset) marker.setZIndexOffset(1000);
            matches.push({ marker, idx });
          } else if (query.length > 0) {
            if (map.hasLayer(marker)) marker.remove(); // Hide
            if (marker.setZIndexOffset) marker.setZIndexOffset(0);
          } else {
            if (!map.hasLayer(marker)) marker.addTo(map); // Show all on reset
            if (marker.setZIndexOffset) marker.setZIndexOffset(0);
          }
        });

        // Show up to 5 results
        if (query.length === 0 || matches.length === 0) {
          resultsHtml = matches.length === 0 && query.length > 0 ? "<div>No matches found.</div>" : "";
        } else {
          resultsHtml = "<ul style='list-style:none;padding:0;margin:0;'>";
          matches.slice(0, 5).forEach(({ marker }, i) => {
            const props = marker.feature.properties;
            resultsHtml += `
        <li style="margin-bottom:14px;">
          <a href="#" style="font-weight:600;font-size:1.05em;color:#255bbd;text-decoration:none;" onclick="focusSpring(${
            marker._leaflet_id
          });return false;">
            ${props["Spring Name"] || "Hot Spring"}
          </a>
          <div style="color:#444;font-size:0.95em;">
            ${props.SC ? props.SC + ", " : ""}${props["USGS Quadrangle"] ? props["USGS Quadrangle"] : ""}
            ${props.TF ? `<span style="color:#666;">, ${props.TF}°F</span>` : ""}
          </div>
        </li>
      `;
          });
          resultsHtml += "</ul>";
          if (matches.length > 5) {
            resultsHtml += `<div style="color:#888;font-size:0.97em;">${matches.length - 5} more found...</div>`;
          }
        }
        resultsDiv.innerHTML = resultsHtml;

        // Scroll to results if on mobile
        if (window.innerWidth < 900) {
          resultsDiv.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // Helper: Clicking result opens marker popup and centers map
        window.focusSpring = function (leafletId) {
          const found = markerList.find(({ marker }) => marker._leaflet_id === leafletId);
          if (found) {
            map.setView(found.marker.getLatLng(), 11, { animate: true });
            found.marker.openPopup();
            bounceMarker(found.marker);
          }
        };
      }

      function resetMapView() {
        map.setView([39, -100], 4);
        markerList.forEach(({ marker }) => {
          if (!map.hasLayer(marker)) marker.addTo(map); // Show all
          if (marker.setStyle) marker.setStyle({ opacity: 1, fillOpacity: 0.95 });
          if (marker.setOpacity) marker.setOpacity(1);
          if (marker.setZIndexOffset) marker.setZIndexOffset(0);
        });
      }

      // Search button click
      document.getElementById("search-btn").addEventListener("click", doSearch);

      // Enter key in search input
      document.getElementById("search").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          doSearch();
        }
      });

      // Show/hide clear button and clear on click
      const searchInput = document.getElementById("search");
      const clearBtn = document.getElementById("search-clear");

      searchInput.addEventListener("input", function () {
        clearBtn.style.display = searchInput.value.length > 0 ? "block" : "none";
      });

      clearBtn.addEventListener("click", function () {
        searchInput.value = "";
        clearBtn.style.display = "none";
        doSearch(); // This will reset markers, but let’s add resetMapView for zoom too
        resetMapView();
        searchInput.focus();
      });

      fetch("hot_springs.geojson")
        .then((response) => response.json())
        .then((data) => {
          markerList = [];
          L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
              const props = feature.properties || {};

              const marker = L.circleMarker(latlng, {
                radius: 4,
                color: "#56130e", // Border color
                fillColor: "#e03426", // Fill color
                fillOpacity: 0.95,
                weight: 1,
              });
              let popupContent = `<strong>${props["Spring Name"] || "Hot Spring"}</strong>`;
              Object.entries(props).forEach(([key, value]) => {
                if (key !== "Spring Name" && value && value !== "null") popupContent += `<br><b>${key}:</b> ${value}`;
              });
              marker.bindPopup(popupContent);
              marker.addTo(map);
              markerList.push({ marker, name: props["Spring Name"] || "" });
              return marker;
            },
          });
        });
    </script>
  </body>
</html>
